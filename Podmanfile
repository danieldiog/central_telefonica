FROM rockylinux:latest

RUN dnf -y groupinstall "Development Tools"
RUN dnf config-manager --set-enabled powertools
RUN dnf install -y \
    gcc \
    gcc-c++ \
    make \
    wget \
    tar \
    autoconf \
    automake \
    libtool \
    ncurses-devel \
    libxml2-devel \
    sqlite-devel \
    openssl-devel \
    git \
    patch \
    && dnf clean all

RUN alias ll='ls -l'

WORKDIR /usr/src
#Instalar e compilar jansson
RUN git clone https://github.com/akheron/jansson.git && \
    cd jansson && \
    autoreconf -i && \
    ./configure --prefix=/usr --libdir=/usr/lib64 && \
    make && \
    make install

# Instalar e compilar o Asterisk
RUN curl -O http://downloads.asterisk.org/pub/telephony/asterisk/asterisk-20.10.0.tar.gz && \
    tar zxvf asterisk-20.10.0.tar.gz && \
    cd asterisk-20.10.0 && \
    ./contrib/scripts/install_prereq install  && \
    ./configure --libdir=/usr/lib64 --with-jansson-bundled && \
    ./contrib/scripts/get_mp3_source.sh && \
    make && \
    make install && \
    make samples && \
    make config && \
    make install-logrotate
# Expor porta do Asterisk
EXPOSE 5060/udp 5060/tcp 5038/tcp 3478/udp 3478/tcp 443/tcp 10000-20000/udp

# Iniciar o Asterisk
CMD ["asterisk", "-f", "-vvv"]
