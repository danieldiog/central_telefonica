FROM rockylinux:latest

RUN dnf -y groupinstall "Development Tools"
RUN dnf config-manager --set-enabled powertools
RUN dnf install -y \
    gcc \
    gcc-c++ \
    make \
    wget \
    tar \
    autoconf \
    automake \
    libtool \
    ncurses-devel \
    libxml2-devel \
    sqlite-devel \
    openssl-devel \
    git \
    patch \
    vim \
    && dnf clean all

RUN alias ll='ls -l'

# Criar usuário e grupo asterisk
RUN groupadd -g 5000 asterisk && \
    useradd -r -u 5000 -g asterisk -d /var/lib/asterisk -s /sbin/nologin asterisk

# Configurar diretório de trabalho
WORKDIR /usr/src

# Instalar e compilar Jansson
RUN git clone https://github.com/akheron/jansson.git && \
    cd jansson && \
    autoreconf -i && \
    ./configure --prefix=/usr --libdir=/usr/lib64 && \
    make && \
    make install

# Instalar e compilar o Asterisk
RUN curl -O http://downloads.asterisk.org/pub/telephony/asterisk/asterisk-20.10.0.tar.gz && \
    tar zxvf asterisk-20.10.0.tar.gz && \
    cd asterisk-20.10.0 && \
    ./contrib/scripts/install_prereq install && \
    ./configure --libdir=/usr/lib64 --with-jansson-bundled && \
    ./contrib/scripts/get_mp3_source.sh && \
    make && \
    make install && \
    make samples && \
    make config && \
    make install-logrotate

# Ajustar permissões
RUN chown -R asterisk:asterisk \
        /etc/asterisk \
        /var/{lib,log,spool,run}/asterisk \
        /usr/lib64/asterisk

# Definir usuário para execução
USER asterisk

# Iniciar o Asterisk
CMD ["asterisk", "-f", "-vvv"]
